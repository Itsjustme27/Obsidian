
## Exploiting SMB

**Types of SMB Exploit 

While there are vulnerabilities such as [CVE-2017-7494](https://www.cvedetails.com/cve/CVE-2017-7494/) that can allow remote code execution by exploiting SMB, you're more likely to encounter a situation where the best way into a system is due to misconfigurations in the system. In this case, we're going to be exploiting anonymous SMB share access- a common misconfiguration that can allow us to gain information that will lead to a shell.  

**Method Breakdown**

So, from our enumeration stage, we know:

    - The SMB share location

    - The name of an interesting SMB share  

**SMBClient**

Because we're trying to access an SMB share, we need a client to access resources on servers. We will be using SMBClient because it's part of the default samba suite. While it’s already installed on the AttackBox, if you do need to install it on your own attacking machine, you can find the documentation [here.](https://www.samba.org/samba/docs/current/man-html/smbclient.1.html)

We can remotely access the SMB share using the syntax:

`smbclient //[IP]/[SHARE]`

Followed by the tags:

-U [name] : to specify the user

-p [port] : to specify the port

# Write-ups
### Task 2: Understanding SMB[](https://blog.davidvarghese.net/posts/tryhackme-network-services/#task-2-understanding-smb)

[![ns-smb-1](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-1.png)](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-1.png)

**1. What does SMB stand for?**

> Server Message Block

**2. What type of protocol is SMB?**

> response-request

**3. What do clients connect to servers using?**

> TCP/IP

[![ns-smb-2](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-2.png)](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-2.png)

**4. What systems does Samba run on?**

> Unix

### Task 3: Enumerating SMB[](https://blog.davidvarghese.net/posts/tryhackme-network-services/#task-3-enumerating-smb)

**1. Conduct an Nmap scan of your choosing, How many ports are open?**

[![ns-smb-3](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-3.png)](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-3.png)

`|   |   | |---|---| |1|sudo nmap -sS -T4 -A -p- 10.10.44.59 -oN nmap_smb.txt|`

`-sS`: Stealth Scan (Uses partial TCP handshake)  
`-A`: Aggressive Scan (Service Versioning, OS Detection and Default Nmap Scripts)  
`-T4`: Timing Template (Aggressive) - Faster Scan  
`-p-`: Scan all 65,535 ports  
`-oN`: Save result as Text (Normal Output)

> 3

**2. What ports is SMB running on?**

The target is running Linux. So instead of SMB, we will see Samba.

> 139/445

**3. Let’s get started with Enum4Linux, conduct a full basic enumeration. For starters, what is the workgroup name?**

The answers to the below question can also be found using Nmap Aggressive Scan.

`|   |   | |---|---| |1|enum4linux -a 10.10.44.59|`

`-a`: All Enumerations

[![ns-smb-4](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-4.png)](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-4.png)

> WORKGROUP

**4. What comes up as the name of the machine?**

> POLOSMB

**5. What operating system version is running?**

> 6.1

**6. What share sticks out as something we might want to investigate?**

`IPC$` and `print$` are default SMB shares. `netlogon` is a share that belongs to the Network Login service. By process of elimination, the share that sticks out is `profiles`.

[![ns-smb-5](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-5.png)](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-5.png)

> profiles

### Task 4: Exploiting SMB[](https://blog.davidvarghese.net/posts/tryhackme-network-services/#task-4-exploiting-smb)

**1. What would be the correct syntax to access an SMB share called “secret” as user “suit” on a machine with the IP 10.10.10.2 on the default port?**

> smbclient //10.10.10.2/secret -U suit

**2. Great! Now you’ve got a hang of the syntax, let’s have a go at trying to exploit this vulnerability. You have a list of users, the name of the share (SMB) and a suspected vulnerability.**

> No answer needed

**3. Let’s see if our interesting share has been configured to allow anonymous access, i.e. it doesn’t require authentication to view the files. We can do this easily by:**  
**Using the username “Anonymous”**  
**Connecting to the share we found during the enumeration stage**  
**and not supplying a password.**  
**Does the share allow anonymous access? (Y/N)**

[![ns-smb-6](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-6.png)](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-6.png)

`|   |   | |---|---| |1|smbclient //10.10.44.59/profiles -U Anonymous|`

`-U`: SMB Username

> Y

**4. Great! Have a look around for any interesting documents that could contain valuable information. Who can we assume this profile folder belongs to?**

The file that stands out is “Working From Home Information.txt”. Using the `more` command the content of the file can be read.

`|   |   | |---|---| |1|more "Working From Home Information.txt"|`

[![ns-smb-7](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-7.png)](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-7.png)

> John Cactus

**5. What service has been configured to allow him to work from home?**

> SSH

**6. Okay! Now we know this, what directory on the share should we look in?**

SSH keys are stored in the `.ssh` directory. By default the public key of the server is saved in a file called `id_rsa` and the public key is stored in a file called `id_rsa.pub`. To connect to the server we require its private key. Since we do not know the SSH username for John Cactus I downloaded the public key as the public key will contain the SSH username.

Multiple files can be downloaded from an SMB server using the `mget` command.

`|   |   | |---|---| |1|mget id_rsa id_rsa.pub|`

[![ns-smb-8](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-8.png)](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-8.png)

> .ssh

**7. This directory contains authentication keys that allow a user to authenticate themselves on, and then access, a server. Which of these keys is most useful to us?**

> id_rsa

**8. Download this file to your local machine, and change the permissions to “600” using “chmod 600 [file]”. Then, use the information you have already gathered to work out the username of the account. Then, use the service and key to log in to the server.  
What is the smb.txt flag?**

`|   |   | |---|---| |1<br>2<br>3<br>4<br>5<br>6|# Change the Permission on SSH key<br>sudo chmod 600 id_rsa<br># SSH connection using the SSH key<br>ssh cactus@10.10.44.59 -i id_rsa<br><br>cat smb.txt|`

[![ns-smb-9](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-9.png)](https://blog.davidvarghese.net/assets/images/thm-network-services/ns-smb-9.png)

> THM{smb_is_fun_eh?}


